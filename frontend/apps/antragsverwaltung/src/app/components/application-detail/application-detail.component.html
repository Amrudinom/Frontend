<div class="container">
  <a routerLink="/antraege" class="back-link">‚Üê Zur√ºck zur √úbersicht</a>

  <h1>√úbermitteltes Formular</h1>

  <div *ngIf="loading" class="loading">Lade Formulardaten‚Ä¶</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <ng-container *ngIf="!loading && data">

    <!-- Fallback f√ºr alte Antr√§ge ohne Snapshot -->
    <div *ngIf="!data.formularSnapshot || !data.formularAntworten" class="warning">
      F√ºr diesen Antrag ist noch kein Formular-Snapshot vorhanden (Altantrag).
    </div>

    <div *ngIf="data.formularSnapshot" class="meta-card">
      <h2>{{ data.formularSnapshot.titel }}</h2>
      <p class="muted">{{ data.formularSnapshot.beschreibung }}</p>

      <div class="meta-grid">
        <div><strong>Antrag-ID:</strong> {{ data.antragId }}</div>
        <div><strong>Status:</strong> {{ data.status }}</div>
        <div><strong>Antragsteller:</strong> {{ data.antragstellerName }}</div>
        <div><strong>Kategorie:</strong> {{ data.formularSnapshot.kategorie }}</div>
        <div *ngIf="data.formularSnapshot.version">
          <strong>Formular-Version:</strong> {{ data.formularSnapshot.version }}
        </div>
        <div>
          <strong>Eingereicht:</strong> {{ data.eingereichtAm | date:'dd.MM.yyyy' }}
        </div>
      </div>
      <div class="status-editor">
        <h3>Status √§ndern</h3>

        <div class="row">
          <label for="status">Neuer Status</label>
          <select id="status" [(ngModel)]="selectedStatus">
            <option [ngValue]="null" disabled>Bitte w√§hlen‚Ä¶</option>
            <option *ngFor="let s of statusOptions" [value]="s.value">
              {{ s.label }}
            </option>
          </select>
        </div>
        <div class="reject-reason" *ngIf="selectedStatus === 'ABGELEHNT'">
          <label for="grund">Ablehnungsgrund</label>
          <textarea
            id="grund"
            rows="4"
            [(ngModel)]="ablehnungsgrund"
            placeholder="Bitte den Ablehnungsgrund angeben..."
          ></textarea>
          <small class="hint">Dieser Text wird dem Antragsteller per E-Mail zugeschickt.</small>
        </div>
        <button
          type="button"
          (click)="saveStatus(data!.antragId)"
          [disabled]="savingStatus || !selectedStatus"
        >
          {{ savingStatus ? 'Speichern‚Ä¶' : 'Status speichern' }}
        </button>

        <div class="success" *ngIf="statusSuccess">{{ statusSuccess }}</div>
      </div>

    </div>

    <div *ngIf="data.formularSnapshot" class="fields-card">
      <h3>Felder & Antworten</h3>

      <div *ngFor="let feld of data.formularSnapshot.felder" class="field-row">
        <div class="field-label">
          <div class="label-line">
            {{ feld.label }}
            <span *ngIf="feld.pflichtfeld" class="required">*</span>
          </div>

          <div *ngIf="feld.oauthAutoFill" class="oauth-hint">
            OAuth: {{ feld.oauthAutoFill }}
          </div>

          <div *ngIf="feld.placeholder" class="muted small">
            Platzhalter: {{ feld.placeholder }}
          </div>
        </div>

        <div class="field-value">
          <ng-container *ngIf="valueForField(feld) as v; else empty">
            {{ displayValue(feld, v) }}
          </ng-container>
          <ng-template #empty>‚Äî</ng-template>
        </div>
      </div>
      <!-- NACHRICHTEN -->
      <div class="section">
        <h3>Kommunikation</h3>

        <div class="message" *ngFor="let n of nachrichten">
          <div class="meta">
            <strong>{{ n.gesendetVon.name }}</strong>
            <span>{{ n.gesendetAm | date:'dd.MM.yyyy HH:mm' }}</span>
          </div>
          <div class="text">{{ n.inhalt }}</div>
        </div>

        <textarea [(ngModel)]="messageText"
                  placeholder="Nachricht an Antragsteller schreiben...">
  </textarea>

        <button (click)="sendNachricht(data!.antragId)">Senden</button>
      </div>

      <!-- DOKUMENTE -->
      <div class="section">
        <div class="section-header">
          <h3>Dokumente</h3>

          <label class="upload-btn">
            Datei ausw√§hlen
            <input type="file" (change)="onFileSelected($event)" hidden>
          </label>
        </div>

        <div *ngIf="uploading" class="muted small">Upload l√§uft‚Ä¶</div>

        <div *ngIf="dokumente.length === 0" class="muted">
          Noch keine Dokumente vorhanden.
        </div>

        <div class="doc-list" *ngIf="dokumente.length > 0">
          <div class="doc-row" *ngFor="let d of dokumente">
            <div class="doc-icon">üìÑ</div>

            <div class="doc-info">
              <div class="doc-name">{{ d.filename }}</div>
              <div class="doc-meta">
                {{ d.uploadedBy?.name ?? 'Unbekannt' }}
                ¬∑ {{ d.uploadedAt | date:'dd.MM.yyyy' }}
                <span *ngIf="d.fileSize">¬∑ {{ d.fileSize }} bytes</span>
              </div>
            </div>

            <div class="doc-actions">
              <button type="button" class="btn secondary"
                      (click)="downloadDokument(data!.antragId, d.id)">
                Download
              </button>

              <button type="button" class="btn danger"
                      (click)="deleteDokument(data!.antragId, d.id)"
                      [disabled]="deletingDocId === d.id">
                {{ deletingDocId === d.id ? 'L√∂sche‚Ä¶' : 'L√∂schen' }}
              </button>
            </div>
          </div>
        </div>
      </div>


    </div>

  </ng-container>
</div>
